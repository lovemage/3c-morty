<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>廠商整合範例 - ECPay 四方金流</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px 0;
            text-align: center;
            margin-bottom: 40px;
            border-radius: 10px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .card-header {
            background: #3498db;
            color: white;
            padding: 20px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .card-body {
            padding: 30px;
        }
        
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            position: relative;
        }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4a5568;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .copy-btn:hover {
            background: #2d3748;
        }
        
        .step {
            background: #ecf0f1;
            border-left: 5px solid #3498db;
            padding: 20px;
            margin: 20px 0;
        }
        
        .step h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .language-tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .tab {
            background: #f8f9fa;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab.active {
            background: white;
            border-bottom-color: #3498db;
            color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏪 廠商整合範例</h1>
            <p>ECPay 四方金流 API 整合指南</p>
        </div>
        
        <!-- API 基本說明 -->
        <div class="card">
            <div class="card-header">📋 API 基本資訊</div>
            <div class="card-body">
                <div class="grid">
                    <div>
                        <h4>API 端點</h4>
                        <code>https://corba3c-production.up.railway.app/api/third-party/barcode/create</code>
                        
                        <h4 style="margin-top: 20px;">驗證方式</h4>
                        <p>請在 HTTP Header 中加入您的 API Key：</p>
                        <div class="code-block">
                            X-API-KEY: your-api-key-here
                        </div>
                    </div>
                    <div>
                        <h4>請求參數</h4>
                        <ul>
                            <li><strong>amount</strong> (必填): 付款金額 (1-6000)</li>
                            <li><strong>client_order_id</strong> (必填): 您的訂單編號</li>
                            <li><strong>callback_url</strong> (選填): 付款完成通知URL</li>
                        </ul>
                        
                        <h4 style="margin-top: 20px;">回應格式</h4>
                        <p>成功時會返回 ECPay 表單資料，用於跳轉到收銀台</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 整合步驟 -->
        <div class="card">
            <div class="card-header">🚀 整合步驟</div>
            <div class="card-body">
                <div class="step">
                    <h4>步驟 1: 呼叫 API 建立訂單</h4>
                    <p>向我們的 API 發送 POST 請求，建立付款訂單</p>
                </div>
                
                <div class="step">
                    <h4>步驟 2: 取得 ECPay 表單資料</h4>
                    <p>API 會回傳 <code>ecpay_form</code> 物件，包含跳轉所需的所有資料</p>
                </div>
                
                <div class="step">
                    <h4>步驟 3: 建立 HTML 表單並自動提交</h4>
                    <p>使用回傳的資料建立表單，跳轉到 ECPay 收銀台</p>
                </div>
                
                <div class="step">
                    <h4>步驟 4: 用戶完成付款</h4>
                    <p>用戶在 ECPay 頁面完成條碼付款，系統自動通知您</p>
                </div>
            </div>
        </div>
        
        <!-- 程式碼範例 -->
        <div class="card">
            <div class="card-header">💻 程式碼範例</div>
            <div class="card-body">
                <div class="language-tabs">
                    <button class="tab active" onclick="showTab('javascript')">JavaScript</button>
                    <button class="tab" onclick="showTab('php')">PHP</button>
                    <button class="tab" onclick="showTab('python')">Python</button>
                </div>
                
                <!-- JavaScript 範例 -->
                <div id="javascript" class="tab-content active">
                    <h4>1. 建立訂單</h4>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">複製</button>
<pre>async function createPayment(amount, orderId) {
    try {
        const response = await fetch('https://corba3c-production.up.railway.app/api/third-party/barcode/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-KEY': 'your-api-key-here'
            },
            body: JSON.stringify({
                amount: amount,
                client_order_id: orderId,
                callback_url: 'https://your-site.com/webhook'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // 取得 ECPay 表單資料
            redirectToECPay(data.data.ecpay_form);
        } else {
            console.error('建立訂單失敗:', data.message);
        }
    } catch (error) {
        console.error('API 呼叫失敗:', error);
    }
}</pre>
                    </div>
                    
                    <h4>2. 跳轉到 ECPay</h4>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">複製</button>
<pre>function redirectToECPay(ecpayForm) {
    // 建立隱藏表單
    const form = document.createElement('form');
    form.method = ecpayForm.method;
    form.action = ecpayForm.action;
    form.style.display = 'none';
    
    // 加入所有參數作為隱藏欄位
    Object.entries(ecpayForm.params).forEach(([key, value]) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    });
    
    // 提交表單
    document.body.appendChild(form);
    form.submit();
}</pre>
                    </div>
                </div>
                
                <!-- PHP 範例 -->
                <div id="php" class="tab-content">
                    <h4>1. 建立訂單</h4>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">複製</button>
<pre>&lt;?php
function createPayment($amount, $orderId) {
    $url = 'https://corba3c-production.up.railway.app/api/third-party/barcode/create';
    
    $data = [
        'amount' => $amount,
        'client_order_id' => $orderId,
        'callback_url' => 'https://your-site.com/webhook.php'
    ];
    
    $options = [
        'http' => [
            'method' => 'POST',
            'header' => [
                'Content-Type: application/json',
                'X-API-KEY: your-api-key-here'
            ],
            'content' => json_encode($data)
        ]
    ];
    
    $context = stream_context_create($options);
    $response = file_get_contents($url, false, $context);
    $result = json_decode($response, true);
    
    if ($result['success']) {
        return $result['data'];
    } else {
        throw new Exception('建立訂單失敗: ' . $result['message']);
    }
}
?&gt;</pre>
                    </div>
                    
                    <h4>2. 產生 ECPay 表單</h4>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">複製</button>
<pre>&lt;?php
function generateECPayForm($ecpayForm) {
    $html = '&lt;form id="ecpayForm" method="' . $ecpayForm['method'] . '" action="' . $ecpayForm['action'] . '"&gt;';
    
    foreach ($ecpayForm['params'] as $key => $value) {
        $html .= '&lt;input type="hidden" name="' . $key . '" value="' . $value . '"&gt;';
    }
    
    $html .= '&lt;/form&gt;';
    $html .= '&lt;script&gt;document.getElementById("ecpayForm").submit();&lt;/script&gt;';
    
    return $html;
}

// 使用方式
try {
    $paymentData = createPayment(299, 'order_' . time());
    echo generateECPayForm($paymentData['ecpay_form']);
} catch (Exception $e) {
    echo '錯誤: ' . $e->getMessage();
}
?&gt;</pre>
                    </div>
                </div>
                
                <!-- Python 範例 -->
                <div id="python" class="tab-content">
                    <h4>1. 建立訂單</h4>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">複製</button>
<pre>import requests
import json

def create_payment(amount, order_id):
    url = 'https://corba3c-production.up.railway.app/api/third-party/barcode/create'
    
    headers = {
        'Content-Type': 'application/json',
        'X-API-KEY': 'your-api-key-here'
    }
    
    data = {
        'amount': amount,
        'client_order_id': order_id,
        'callback_url': 'https://your-site.com/webhook'
    }
    
    response = requests.post(url, headers=headers, json=data)
    result = response.json()
    
    if result['success']:
        return result['data']
    else:
        raise Exception(f"建立訂單失敗: {result['message']}")

# 使用方式
try:
    payment_data = create_payment(299, f"order_{int(time.time())}")
    ecpay_form = payment_data['ecpay_form']
    print("ECPay 表單資料:", ecpay_form)
except Exception as e:
    print("錯誤:", str(e))</pre>
                    </div>
                    
                    <h4>2. Flask 範例 (產生跳轉頁面)</h4>
                    <div class="code-block">
                        <button class="copy-btn" onclick="copyCode(this)">複製</button>
<pre>from flask import Flask, render_template_string

def generate_ecpay_form(ecpay_form):
    template = '''
    &lt;html&gt;
    &lt;body&gt;
        &lt;form id="ecpayForm" method="{{ method }}" action="{{ action }}"&gt;
            {% for key, value in params.items() %}
            &lt;input type="hidden" name="{{ key }}" value="{{ value }}"&gt;
            {% endfor %}
        &lt;/form&gt;
        &lt;script&gt;
            document.getElementById("ecpayForm").submit();
        &lt;/script&gt;
    &lt;/body&gt;
    &lt;/html&gt;
    '''
    
    return render_template_string(template, 
                                method=ecpay_form['method'],
                                action=ecpay_form['action'],
                                params=ecpay_form['params'])

# 在 Flask 路由中使用
@app.route('/checkout')
def checkout():
    try:
        payment_data = create_payment(299, f"order_{int(time.time())}")
        return generate_ecpay_form(payment_data['ecpay_form'])
    except Exception as e:
        return f"錯誤: {str(e)}"</pre>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 注意事項 -->
        <div class="card">
            <div class="card-header">⚠️ 重要注意事項</div>
            <div class="card-body">
                <div class="warning">
                    <h4>安全性提醒</h4>
                    <ul>
                        <li>請妥善保管您的 API Key，不要在前端程式碼中暴露</li>
                        <li>建議實作 IP 白名單限制</li>
                        <li>callback_url 建議使用 HTTPS</li>
                    </ul>
                </div>
                
                <div class="success">
                    <h4>最佳實作</h4>
                    <ul>
                        <li>在用戶點擊「結帳」時才呼叫 API</li>
                        <li>為避免重複訂單，每個 client_order_id 應該是唯一的</li>
                        <li>建議在跳轉前顯示載入提示</li>
                        <li>實作付款完成後的狀態查詢機制</li>
                    </ul>
                </div>
                
                <h4>測試環境</h4>
                <p>您可以使用我們提供的測試頁面來驗證整合：</p>
                <div class="code-block">
                    <a href="ecpay-checkout-test.html" target="_blank" style="color: #61dafb; text-decoration: none;">
                        🧪 開啟 ECPay 跳轉測試頁面
                    </a>
                </div>
            </div>
        </div>
        
        <!-- API 回應範例 -->
        <div class="card">
            <div class="card-header">📤 API 回應範例</div>
            <div class="card-body">
                <h4>成功回應</h4>
                <div class="code-block">
                    <button class="copy-btn" onclick="copyCode(this)">複製</button>
<pre>{
  "success": true,
  "data": {
    "order_id": 27,
    "client_order_id": "test_order_1755514318",
    "merchant_trade_no": "TPA1755514321045027",
    "trade_no": null,
    "store_type": "7ELEVEN",
    "amount": 299,
    "expire_date": "2025-08-25T10:52:01.045Z",
    "customer_info_url": "https://corba3c-production.up.railway.app/customer-info/27",
    "barcode_status": "generated",
    "payment_method": "ecpay_redirect",
    "ecpay_form": {
      "action": "https://payment.ecpay.com.tw/Cashier/AioCheckOut/V5",
      "method": "POST",
      "params": {
        "MerchantID": "3466445",
        "MerchantTradeNo": "TPA1755514321045027",
        "MerchantTradeDate": "2025/08/18 10:52:01",
        "PaymentType": "aio",
        "TotalAmount": 299,
        "TradeDesc": "7ELEVEN便利店條碼付款",
        "ItemName": "3C商品一組 - NT$299",
        "ReturnURL": "https://corba3c-production.up.railway.app/api/third-party/ecpay/callback",
        "ChoosePayment": "BARCODE",
        "EncryptType": 1,
        "StoreExpireDate": 7,
        "PaymentInfoURL": "https://corba3c-production.up.railway.app/api/third-party/ecpay/payment-info",
        "Desc_1": "7-ELEVEN",
        "CheckMacValue": "A7617606192BDF2D8A4DA34A03166BD069260CF9B61DD97C11F0076A2259C586"
      }
    },
    "message": "訂單建立成功，請使用ecpay_form建立POST表單跳轉到ECPay頁面進行條碼付款",
    "integration_instructions": [
      "使用ecpay_form.action作為表單的action URL",
      "使用ecpay_form.method (POST)作為表單方法", 
      "將ecpay_form.params中的所有參數作為隱藏欄位添加到表單",
      "提交表單將跳轉到ECPay條碼頁面",
      "用戶完成付款後，系統會收到付款通知"
    ]
  }
}</pre>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showTab(language) {
            // 隱藏所有內容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有 tab 的 active 狀態
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 顯示選中的內容
            document.getElementById(language).classList.add('active');
            
            // 設置選中的 tab
            event.target.classList.add('active');
        }
        
        function copyCode(button) {
            const codeBlock = button.parentElement.querySelector('pre');
            const text = codeBlock.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                button.textContent = '已複製!';
                setTimeout(() => {
                    button.textContent = '複製';
                }, 2000);
            });
        }
    </script>
</body>
</html>